<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Similara - Tekstvergelijking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .diff-view { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; }
        .match { color: #15803d; background-color: #dcfce7; padding: 0 2px; border-radius: 4px; border-bottom: 2px solid #bdf2cb; }
        .mismatch { color: #b91c1c; background-color: #fee2e2; padding: 0 2px; border-radius: 4px; border-bottom: 2px solid #fecaca; }
        .percentage-grow { transition: color 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-8">

    <!-- Language Toggle (Top Left) -->
    <div class="absolute top-4 left-4 md:top-8 md:left-8 z-50">
        <div class="bg-slate-200 p-1 rounded-lg flex gap-1 shadow-sm">
            <button id="langNL" onclick="setLanguage('nl')" class="px-3 py-1 rounded text-xs font-bold transition-all bg-white text-slate-900 shadow-sm">NL</button>
            <button id="langEN" onclick="setLanguage('en')" class="px-3 py-1 rounded text-xs font-bold transition-all text-slate-500 hover:text-slate-700">EN</button>
        </div>
    </div>

    <!-- Header & Score -->
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mt-12 md:mt-0 mb-6 gap-4">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-3xl font-800 text-slate-900 tracking-tight">Similara</h1>
                <span class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-1 rounded uppercase">v2.5</span>
            </div>
            <p id="ui-subtitle" class="text-slate-500">Vergelijk tekstovereenkomst op basis van woorden of betekenis.</p>
        </div>
        
        <div class="bg-white shadow-xl rounded-2xl p-6 border border-slate-100 flex flex-col items-center gap-1 min-w-[240px] justify-center relative">
            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest" id="ui-scoreLabel">Overeenkomst Score</span>
            <div id="similarityScore" class="text-6xl font-800 text-slate-300 percentage-grow">0%</div>
            <div id="modeBadge" class="mt-2 text-[10px] font-bold uppercase px-2 py-0.5 rounded bg-slate-100 text-slate-500">Letterlijke Modus</div>
        </div>
    </header>

    <!-- Settings Toggle -->
    <div class="flex flex-col items-center mb-8 gap-3">
        <div class="bg-slate-200 p-1 rounded-xl flex gap-1">
            <button id="modeLiteral" onclick="setMode('literal')" class="px-6 py-2 rounded-lg text-sm font-bold transition-all bg-white text-slate-900 shadow-sm">Letterlijke Match</button>
            <button id="modeAI" onclick="setMode('ai')" class="px-6 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700">AI Betekenis Match</button>
        </div>
        <p id="modeDesc" class="text-xs text-slate-500 italic">Controleren op exact dezelfde woorden...</p>
    </div>

    <!-- Main Comparison Area -->
    <main class="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="flex flex-col gap-2">
            <label id="ui-sourceLabel" class="font-bold text-slate-600 ml-1 uppercase text-[10px] tracking-widest">Originele Bron (Het Doel)</label>
            <textarea id="sourceInput" class="w-full flex-grow min-h-[300px] lg:min-h-full p-5 rounded-2xl border-2 border-slate-100 shadow-sm focus:ring-4 focus:ring-indigo-50 focus:border-indigo-500 outline-none resize-none transition-all text-slate-700 leading-relaxed" placeholder="Plak de mastertekst hier..."></textarea>
        </div>

        <div class="flex flex-col gap-2 relative">
            <label class="font-bold text-slate-600 ml-1 flex justify-between uppercase text-[10px] tracking-widest">
                <span id="ui-attemptLabel">Poging van Student</span>
                <span id="viewToggle" class="text-indigo-600 cursor-pointer hidden hover:text-indigo-800 transition-colors">✎ Bewerk Tekst</span>
            </label>
            <div id="destContainer" class="relative flex-grow min-h-[300px] lg:min-h-full">
                <textarea id="destInput" class="w-full h-full p-5 rounded-2xl border-2 border-slate-100 shadow-sm focus:ring-4 focus:ring-indigo-50 focus:border-indigo-500 outline-none resize-none transition-all block text-slate-700 leading-relaxed" placeholder="Typ je tekst hier..."></textarea>
                <div id="highlightOutput" class="absolute inset-0 w-full h-full p-5 rounded-2xl border-2 border-slate-100 bg-white overflow-auto diff-view hidden"></div>
            </div>
        </div>
    </main>

    <!-- Feedback & Action -->
    <footer class="mt-8 flex flex-col items-center gap-6">
        <div id="aiFeedbackBox" class="max-w-2xl w-full bg-indigo-50 border border-indigo-100 p-4 rounded-xl hidden text-sm text-indigo-800 animate-in fade-in slide-in-from-bottom-2 duration-500">
            <strong id="ui-feedbackTitle" class="block mb-1 uppercase text-[10px] tracking-wider text-indigo-400">AI Feedback</strong>
            <span id="aiFeedbackText"></span>
        </div>

        <button id="compareBtn" onclick="handleCompare()" class="group relative inline-flex items-center justify-center px-16 py-4 font-bold text-white transition-all duration-200 bg-emerald-600 rounded-2xl hover:bg-emerald-700 shadow-lg hover:shadow-emerald-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
            <span id="btnText">Vergelijken & Scoren</span>
        </button>
        
        <div id="errorMessage" class="text-sm text-red-500 font-medium hidden"></div>

        <!-- Attribution & License Footer -->
        <div id="ui-footerCredits" class="mt-8 text-center text-[10px] text-slate-400 max-w-md mx-auto leading-relaxed border-t border-slate-100 pt-6">
            <!-- Content dynamic via JS -->
        </div>
    </footer>

    <script>
        const apiKey = ""; 
        let currentMode = 'literal';
        let currentLang = 'nl';

        const translations = {
            nl: {
                subtitle: "Vergelijk tekstovereenkomst op basis van woorden of betekenis.",
                scoreLabel: "Overeenkomst Score",
                literalMode: "Letterlijke Modus",
                aiMode: "AI Betekenis Modus",
                btnLiteral: "Letterlijke Match",
                btnAI: "AI Betekenis Match",
                descLiteral: "Controleren op exact dezelfde woorden...",
                descAI: "Analyseren van intentie, toon en semantische betekenis...",
                sourceLabel: "Originele Bron (Het Doel)",
                sourcePlaceholder: "Plak de mastertekst hier...",
                attemptLabel: "Poging van Student",
                attemptPlaceholder: "Typ je tekst hier...",
                btnCompare: "Vergelijken & Scoren",
                btnAnalyzing: "Analyseren",
                editText: "✎ Bewerk Tekst",
                feedbackTitle: "AI Feedback",
                errorMsg: "Controleer je verbinding en probeer het opnieuw.",
                footerCredits: "Gemaakt door <strong>Jelmar Groot</strong> en gepubliceerd onder de <strong>MIT-licentie</strong>. Dit betekent dat je de software vrij mag gebruiken, kopiëren, aanpassen en verspreiden (ook commercieel), mits de bronvermelding behouden blijft."
            },
            en: {
                subtitle: "Compare text similarity by words or by meaning.",
                scoreLabel: "Similarity Score",
                literalMode: "Literal Mode",
                aiMode: "AI Meaning Mode",
                btnLiteral: "Literal Match",
                btnAI: "AI Meaning Match",
                descLiteral: "Checking for exact word-for-word accuracy...",
                descAI: "Analyzing intent, tone, and semantic meaning...",
                sourceLabel: "Original Source (The Goal)",
                sourcePlaceholder: "Paste the master text here...",
                attemptLabel: "Student Attempt",
                attemptPlaceholder: "Type your recreation here...",
                btnCompare: "Compare & Score",
                btnAnalyzing: "Analyzing",
                editText: "✎ Edit Text",
                feedbackTitle: "AI Feedback",
                errorMsg: "Check your connection and try again.",
                footerCredits: "Built by <strong>Jelmar Groot</strong> and published under an <strong>MIT license</strong>. This means you are free to use, copy, modify, and distribute this software for any purpose, as long as the original attribution is included."
            }
        };
        
        const sourceInput = document.getElementById('sourceInput');
        const destInput = document.getElementById('destInput');
        const highlightOutput = document.getElementById('highlightOutput');
        const similarityDisplay = document.getElementById('similarityScore');
        const viewToggle = document.getElementById('viewToggle');
        const compareBtn = document.getElementById('compareBtn');
        const btnText = document.getElementById('btnText');
        const errorMessage = document.getElementById('errorMessage');
        const modeBadge = document.getElementById('modeBadge');
        const modeDesc = document.getElementById('modeDesc');
        const aiFeedbackBox = document.getElementById('aiFeedbackBox');
        const aiFeedbackText = document.getElementById('aiFeedbackText');
        const footerCredits = document.getElementById('ui-footerCredits');

        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            
            document.getElementById('langNL').className = lang === 'nl' ? 'px-3 py-1 rounded text-xs font-bold transition-all bg-white text-slate-900 shadow-sm' : 'px-3 py-1 rounded text-xs font-bold transition-all text-slate-500 hover:text-slate-700';
            document.getElementById('langEN').className = lang === 'en' ? 'px-3 py-1 rounded text-xs font-bold transition-all bg-white text-slate-900 shadow-sm' : 'px-3 py-1 rounded text-xs font-bold transition-all text-slate-500 hover:text-slate-700';
            
            document.getElementById('ui-subtitle').innerText = t.subtitle;
            document.getElementById('ui-scoreLabel').innerText = t.scoreLabel;
            document.getElementById('modeLiteral').innerText = t.btnLiteral;
            document.getElementById('modeAI').innerText = t.btnAI;
            document.getElementById('ui-sourceLabel').innerText = t.sourceLabel;
            sourceInput.placeholder = t.sourcePlaceholder;
            document.getElementById('ui-attemptLabel').innerText = t.attemptLabel;
            destInput.placeholder = t.attemptPlaceholder;
            btnText.innerText = t.btnCompare;
            viewToggle.innerText = t.editText;
            document.getElementById('ui-feedbackTitle').innerText = t.feedbackTitle;
            footerCredits.innerHTML = t.footerCredits;
            
            setMode(currentMode);
        }

        function setMode(mode) {
            currentMode = mode;
            const t = translations[currentLang];
            
            document.getElementById('modeLiteral').className = mode === 'literal' ? 'px-6 py-2 rounded-lg text-sm font-bold transition-all bg-white text-slate-900 shadow-sm' : 'px-6 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700';
            document.getElementById('modeAI').className = mode === 'ai' ? 'px-6 py-2 rounded-lg text-sm font-bold transition-all bg-white text-slate-900 shadow-sm' : 'px-6 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700';
            
            modeBadge.innerText = mode === 'ai' ? t.aiMode : t.literalMode;
            modeBadge.className = mode === 'ai' ? 'mt-2 text-[10px] font-bold uppercase px-2 py-0.5 rounded bg-indigo-100 text-indigo-600' : 'mt-2 text-[10px] font-bold uppercase px-2 py-0.5 rounded bg-slate-100 text-slate-500';
            modeDesc.innerText = mode === 'ai' ? t.descAI : t.descLiteral;
            
            renderEmptyState();
        }

        viewToggle.addEventListener('click', () => {
            destInput.classList.remove('hidden');
            highlightOutput.classList.add('hidden');
            viewToggle.classList.add('hidden');
            aiFeedbackBox.classList.add('hidden');
        });

        function clean(word) {
            return word.toLowerCase().trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
        }

        async function getAISimilarity(source, student) {
            const langPrompt = currentLang === 'nl' ? "Geef feedback in het Nederlands." : "Provide feedback in English.";
            const systemPrompt = `You are a very lenient and encouraging educational evaluator. Compare a 'Source' text and a 'Student Attempt'. Score semantic similarity (0-100). 100% means the student captured the core intent perfectly. Be generous. ${langPrompt} Return JSON: {score: number, feedback: string}. Keep feedback under 20 words.`;
            const userQuery = `Source: "${source}"\n\nAttempt: "${student}"`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { 
                            responseMimeType: "application/json", 
                            responseSchema: { 
                                type: "OBJECT", 
                                properties: { score: { type: "NUMBER" }, feedback: { type: "STRING" } },
                                required: ["score", "feedback"]
                            } 
                        }
                    })
                });
                
                const data = await response.json();
                const textResult = data.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(textResult);
            } catch (e) {
                throw new Error("AI Service Unavailable");
            }
        }

        function calculateLiteralSimilarity(s1, s2) {
            const words1 = s1.split(/\s+/).filter(x => x).map(clean);
            const words2 = s2.split(/\s+/).filter(x => x).map(clean);
            if (words1.length === 0 && words2.length === 0) return 100;
            if (words1.length === 0 || words2.length === 0) return 0;
            const set1 = new Set(words1);
            let matches = 0;
            words2.forEach(word => { if (set1.has(word)) matches++; });
            const totalRequired = Math.max(words1.length, words2.length);
            return Math.round((matches / totalRequired) * 100);
        }

        function getColorForScore(score, mode) {
            if (mode === 'ai') {
                if (score > 80) return 'text-emerald-600'; 
                if (score >= 70) return 'text-yellow-500';
                if (score >= 50) return 'text-orange-500';
                return 'text-red-600';
            } else {
                if (score > 95) return 'text-emerald-600';
                if (score >= 90) return 'text-yellow-500';
                if (score >= 85) return 'text-orange-500';
                return 'text-red-600';
            }
        }

        async function handleCompare() {
            const s1 = sourceInput.value.trim();
            const s2 = destInput.value.trim();
            const t = translations[currentLang];
            if (!s1 || !s2) return;

            errorMessage.classList.add('hidden');
            aiFeedbackBox.classList.add('hidden');
            compareBtn.disabled = true;
            btnText.className = "loading-dots";
            btnText.innerText = t.btnAnalyzing;

            try {
                let score = 0;
                if (currentMode === 'literal') {
                    score = calculateLiteralSimilarity(s1, s2);
                } else {
                    const result = await getAISimilarity(s1, s2);
                    score = result.score;
                    aiFeedbackText.innerText = result.feedback;
                    aiFeedbackBox.classList.remove('hidden');
                }

                animateScore(score, currentMode);

                const sourceWords = new Set(s1.split(/\s+/).map(clean));
                const attemptParts = s2.split(/(\s+)/);
                const highlightedHtml = attemptParts.map(part => {
                    if (part.trim() === "") return part;
                    const isMatch = sourceWords.has(clean(part));
                    return `<span class="${isMatch ? 'match' : 'mismatch'}">${part}</span>`;
                }).join('');

                highlightOutput.innerHTML = highlightedHtml;
                destInput.classList.add('hidden');
                highlightOutput.classList.remove('hidden');
                viewToggle.classList.remove('hidden');
            } catch (err) {
                errorMessage.innerText = t.errorMsg;
                errorMessage.classList.remove('hidden');
            } finally {
                compareBtn.disabled = false;
                btnText.className = "";
                btnText.innerText = t.btnCompare;
            }
        }

        function animateScore(target, mode) {
            let current = 0;
            const duration = 1000;
            const start = performance.now();
            function update(now) {
                const elapsed = now - start;
                const progress = Math.min(elapsed / duration, 1);
                current = Math.floor((1 - Math.pow(1 - progress, 3)) * target);
                similarityDisplay.innerText = `${current}%`;
                similarityDisplay.className = `text-6xl font-800 percentage-grow ${getColorForScore(current, mode)}`;
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        function renderEmptyState() {
            similarityDisplay.innerText = '0%';
            similarityDisplay.className = 'text-6xl font-800 text-slate-300 percentage-grow';
            destInput.classList.remove('hidden');
            highlightOutput.classList.add('hidden');
            viewToggle.classList.add('hidden');
            errorMessage.classList.add('hidden');
            aiFeedbackBox.classList.add('hidden');
        }

        window.onload = () => setLanguage('nl');
    </script>
</body>
</html>
